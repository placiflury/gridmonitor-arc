<%inherit file="/base/monadmin.html"/>

<%def name="dom_ready()" >\
	## Initialization of the Controllers:
	var MA_site_list = Object.create(ListController);
	MA_site_list.container = $('#MA_site_list_container');
	MA_site_list.set_title('Sites:');
	MA_site_list.init('MA_site_list', '../resources/getsites');
	var MA_site_list_editor = Object.create(ListEditor);
	MA_site_list_editor.container = $('#MA_site_editor_container');
	MA_site_list_editor.click = true;
	MA_site_list_editor.init(MA_site_list);

	var MA_admin_list = Object.create(ListController);
	MA_admin_list.container = $('#MA_admin_list_container');
	MA_admin_list.multiple = true;
	MA_admin_list.set_title('Admins:');
	MA_admin_list.set_link('exchange', 'edit admin access');
	MA_admin_list.set_link('save');
	MA_admin_list.links.find('#save').hide();
	MA_admin_list.set_link('cancel');
	MA_admin_list.links.find('#cancel').hide();
	MA_admin_list.click = false;
	MA_admin_list.init('MA_adm_list', '../resources/getadms');
	MA_admin_list.hide();
	var MA_admin_list_editor = Object.create(ListEditor);
	MA_admin_list_editor.container = $('#MA_admin_editor_container');
	MA_admin_list_editor.hover = true;
	MA_admin_list_editor.flush_container = true;
	MA_admin_list_editor.init(MA_admin_list);
	
	var MA_mapper = Object.create(ListMapper);
	MA_mapper.init(MA_site_list, MA_admin_list);
	
	var MA_admin_list_inactive = Object.create(ListController);
	MA_admin_list_inactive.container = $('#MA_admin_list_inactive_container');
	MA_admin_list_inactive.multiple = true;
	MA_admin_list_inactive.set_title('Inactive Admins:');
	MA_admin_list_inactive.init('MA_adm_list', '../resources/getadms');
	MA_admin_list_inactive.hide();
	var MA_admin_list_inactive_editor = Object.create(ListEditor);
	MA_admin_list_inactive_editor.container = $('#MA_admin_editor_container');
	MA_admin_list_inactive_editor.hover = true;
	MA_admin_list_inactive_editor.flush_container = true;
	MA_admin_list_inactive_editor.init(MA_admin_list_inactive);
	
	var MA_mapper_inverse = Object.create(ListMapperInverse);
	MA_mapper_inverse.init(MA_site_list, MA_admin_list_inactive);
	
	var MA_admin_list_exchanger = Object.create(ListExchanger);
	MA_admin_list_exchanger.init(MA_admin_list, MA_admin_list_inactive);
	MA_admin_list_exchanger.toggle(false);
	$('#MA_exchange_ltr').click(function() {MA_admin_list_exchanger.ltr(); });
	$('#MA_exchange_rtl').click(function() {MA_admin_list_exchanger.rtl(); });
	$('#MA_exchange_links').hide();
	
	var MA_userinterface = Object.create(MA_UI_Controller);
	MA_userinterface.init();
	
	## Functionality
	var toggle_lock = function(container, force) {
		$(container).css('z-index',function(index,value) {
			if (force == false) {
				return Math.abs(value);
			} else if (force == true) {
				return (-1) * Math.abs(value);
			}
			return value * (-1); 
		});
	}
	var MA_lock = $('#MA_lock') .css('z-index', '-1')
								.css('width', 1092)
								.text(' ')
								.css('height', $('#yui-main').height())
								.css('top', $('#yui-main').css('top'));
	$('#MA_site_list_container').css('z-index', '2');
	$('#MA_admin_list_container').css('z-index', '2');
	$('#MA_admin_list_inactive_container').css('z-index', '2');
	$('#ui').css('height', $('#yui-main').height());
	
	
	MA_admin_list.links.delegate('a#exchange', 'click', function() {
		MA_admin_list_exchanger.toggle(true);
		MA_admin_list.click = true;
		toggle_lock($('#MA_site_list_container'), true);
		MA_userinterface.set();
		MA_admin_list_inactive.show();
		$('#MA_exchange_links').show();
		MA_admin_list.links.find('#exchange').hide();
		MA_admin_list.links.find('#save').show();
		MA_admin_list.links.find('#cancel').show();
	});
	MA_admin_list.links.delegate('a#cancel', 'click', function() {
		MA_mapper.map();
		MA_mapper_inverse.map();
		MA_admin_list_exchanger.toggle(false);
		MA_admin_list.click = false;
		toggle_lock($('#MA_site_list_container'), false);
		MA_userinterface.restore();
	});
	MA_admin_list.links.delegate('a#save', 'click', function() {
		var diff = MA_admin_list_exchanger.get_diff();
		diff['source_id'] = 'MA_site_list';
		diff['target_id'] = 'MA_adm_list';
		diff['source'] = MA_site_list.get_selected().data('info');
		$.post(
				'save',
				diff,
				function(data) {
					MA_mapper.map();
					MA_mapper_inverse.map();
					var answer = data.split(';;;');
					if (answer[0] == 'OK') { $('#MA_status').attr('class', 'ok') }
					else if (answer[0] == 'ERROR') { $('#MA_status').attr('class', 'critical') }
					$('#MA_status').text(answer[1]);
					$('#MA_status').fadeIn().delay(3000).fadeOut();
				},
				"text"
		);
		debug(diff)
		MA_admin_list_exchanger.toggle(false);
		MA_admin_list.click = false;
		toggle_lock($('#MA_site_list_container'), false);
		MA_userinterface.restore();
	});


	
</%def>

<div id="MA_lock" style="position:absolute; background-color: #FFFFFF; opacity: 0.5; filter: alpha(opacity = 50);"></div>

<div id="ui">
	<div id="MA_site_list_container" style="position:relative;"></div>
	<div id="MA_admin_list_container" style="position:relative;"></div>
	<div id="MA_exchange_links" style="position:relative;">
		<div id="MA_exchange_rtl" style="position:relative; top:115px;">&larr;</div>
		<div id="MA_exchange_ltr" style="position:relative; top:115px;">&rarr;</div>
	</div>
	<div id="MA_admin_list_inactive_container" style="position:relative;"></div>
	<div id="MA_editor_container" style="position:relative;">
		<div id="MA_site_editor_container" style="position:relative;"></div>
		<p>&nbsp;</p>
		<div id="MA_admin_editor_container" style="position:relative;"></div>
	</div>
</div>

<div id="MA_status" style="display:none;"></div>



